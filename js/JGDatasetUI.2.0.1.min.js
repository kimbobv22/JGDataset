(function(f,g,h){if(h===undefined){console.error("can't not initialize JGDataset UI, JGDataset not found");return;}var c;_JGKeyword=g.extend(true,f._JGKeyword,{ui:{attrDataset:"jg-dataset",attrColumn:"jg-column",attrBindDataset:"jg-bind-dataset",attrDisplayColumn:"jg-display-column",attrValueColumn:"jg-value-column",keyFXPrefix:"##fx:",trigger:{rowMapped:"datasetuirowmapped",refreshed:"datasetuirefreshed",FXRefreshed:"datasetuifxrefreshed",columnRefreshed:"datasetuicolumnrefreshed",mappingReloaded:"datasetuimappingreloaded"}},select:{trigger:{selectReloaded:"selectreloaded"}}});String.prototype._jgFuncConvertToColumnRegexp=(function(){return new RegExp("\\#\\#("+this+")\\#\\#","gi");});String.prototype._jgFuncReplaceRegexpByDataset=(function(i,t){var s=this;s=s.replace("dataset\\.rowIndex"._jgFuncConvertToColumnRegexp(),t);s=s.replace("dataset\\.rowStatus"._jgFuncConvertToColumnRegexp(),i.getRowStatus(t));s=s.replace("dataset\\.rowCount"._jgFuncConvertToColumnRegexp(),i.getRowCount());s=s.replace("dataset\\.columnCount"._jgFuncConvertToColumnRegexp(),i.getColumnCount());var k="dataset\\.sum\\([\\s\\w\\#\\@\\-\\+\\*\\/\\%]*\\)"._jgFuncConvertToColumnRegexp();if(k.test(s)){var l=i.getColumnCount();for(var m=0;m<l;++m){var q=i.getColumn(m);var r=q.getName();var j=r._jgFuncConvertToColumnRegexp();if(j.test(s)){var p=0;for(var o=0;o<=t;++o){var n=parseInt(i.getColumnValue(r,o));p+=n;}s=s.replace(j,p);}}s=s.replace("dataset\\.sum"._jgFuncConvertToColumnRegexp(),i.getRowCount());s=s.substr(s.indexOf("(")+1);s=s.substr(0,s.indexOf(")##"));}var l=i.getColumnCount();for(var m=0;m<l;++m){var q=i.getColumn(m);var r=q.getName();var n=i.getColumnValue(r,t);s=s.replace(r._jgFuncConvertToColumnRegexp(),"this.getColumnValue('"+r+"',"+t+")");}return s;});g.fn.insertAtIndex=(function(j,k){var i=this.children().size();if(k<0){k=Math.max(0,i+1+k);}this.append(j);if(k<i){this.children().eq(k).before(this.children().last());}return this;});g.fn.selectValue=(function(){if(this.prop("tagName").toLowerCase()!=="select"){return undefined;}return this.children("option:selected").first().attr("value");});JGDataset.prototype.datasetUIView=(function(){return g(document).find("["+_JGKeyword.ui.attrDataset+"='"+this.getName()+"']").filter(function(){return g(this)._jgDatasetUIInitialized();});});var a=f.JGDatasetUI=(function(l,j){var i=this;this._element=l;this._datasetName=NVL(j,l.attr(_JGKeyword.ui.attrDataset));if(isNull(this.dataset())){console.error("can't find JGDataset");return;}this._originalRowContent=this._element.children().first().clone(true);this._element.empty();this._rowContents=new Array();var k=this.dataset();g(k).on(_JGKeyword.trigger._rowInserted,function(m,n){i._insertRowContent(n);});g(k).on(_JGKeyword.trigger._rowRemoved,function(m,n){i._removeRowContent(n);});g(k).on(_JGKeyword.trigger._rowMoved,function(n,m,o){if(m>o){i._refresh(o,m);}else{i._refresh(m,o);}});g(k).on(_JGKeyword.trigger._columnAdded+" "+_JGKeyword.trigger._columnRemoved,function(m,n){i._refreshColumn(n,undefined,undefined,false);i._refreshFX();});g(k).on(_JGKeyword.trigger._columnValueChanged,function(m,o,n){i._refreshColumn(o,n,undefined,false);i._refreshFX();});g(k).on(_JGKeyword.trigger._datasetClear+" "+_JGKeyword.trigger._datasetReset+" "+_JGKeyword.trigger._datasetChanged+" "+_JGKeyword.trigger._datasetSorted,function(m,n,o){i.reload();});g(k).on(_JGKeyword.trigger._datasetApply,function(m){i._refreshFX();});this.reload();});a.prototype.element=(function(){return this._element;});a.prototype.dataset=(function(){return h("dataset",this._datasetName);});a.prototype.rowContent=(function(i){return this._rowContents[i];});a.prototype._insertRowContent=(function(i){var j=new e(this,this._originalRowContent);this._rowContents.insert(j,i);this.element().insertAtIndex(j.rowContent(),i);this._refresh(i,undefined,false);this.element().trigger(_JGKeyword.ui.trigger.rowMapped,[i]);return j;});a.prototype._removeRowContent=(function(i){var j=this.rowContent(i);j.rowContent().remove();this._rowContents.remove(i);this._refreshFX(i);});a.prototype.indexOf=(function(i){return this._rowContents.indexOf(i);});a.prototype.__rowRangeRefresh=(function(j,l,i){var m=this.dataset().getRowCount();if(isNull(j)){j=NVL(j,0);l=NVL(l,m-1);}else{l=NVL(l,j);}for(var k=j;k<=l;++k){i(this,k);}});a.prototype._refreshFX=(function(i,k,j){this.__rowRangeRefresh(i,k,function(l,m){l.rowContent(m)._refreshFX();if(NVL(j,true)){g(l.element()).trigger(_JGKeyword.ui.trigger.FXRefreshed,[m]);}});});a.prototype._refreshColumn=(function(l,i,k,m,j){m=NVL(m,true);this.__rowRangeRefresh(i,k,function(n,o){n.rowContent(o)._refreshColumn(l,m);if(NVL(j,true)){g(n.element()).trigger(_JGKeyword.ui.trigger.columnRefreshed,[l,o]);}});});a.prototype._refresh=(function(i,k,j){this.__rowRangeRefresh(i,k,function(l,m){l.rowContent(m)._refresh();if(NVL(j,true)){g(l.element()).trigger(_JGKeyword.ui.trigger.refreshed,[m]);}});});a.prototype.reload=(function(){this.element().empty();this._rowContents=new Array();var j=this.dataset();var k=j.getRowCount();var i=0;while(i<k){this._insertRowContent(this._rowContents.length);++i;}g(this.element()).trigger(_JGKeyword.ui.trigger.mappingReloaded);});g.fn._jgDatasetUI=(function(i){if(i!==undefined){this.data("jgdatasetJGDatasetUI",i);}return this.data("jgdatasetJGDatasetUI");});g.fn._jgDatasetUIInitialized=(function(i){if(i!==undefined){this.data("jgdataset_jgDatasetInitialized",i);}return NVL(this.data("jgdataset_jgDatasetInitialized"),false);});g.fn.JGDatasetUI=(function(){if(!this._jgDatasetUIInitialized()){this._jgDatasetUI(new a(this,arguments[0]));this._jgDatasetUIInitialized(true);}return JGSelector(this._jgDatasetUI(),arguments);});g.fn._jgDataRowContent=(function(i){if(i===undefined){return this.data("jgdataset_rowContent");}this.data("jgdataset_rowContent",i);return this.data("jgdataset_rowContent");});g.fn._jgDataJGDataset=(function(){return this._jgDataRowContent().datasetUI().dataset();});var e=(function(k,s){this._datasetUI=k;this._rowContent=s.clone(true,true);this._mappedElements=new Array();this._FXElements=new Array();var z=this._rowContent.find("*["+_JGKeyword.ui.attrColumn+"]");var u=z.length;for(var n=0;n<u;++n){var A=g(z[n]);var q=A.prop("tagName").toLowerCase();A._jgDataRowContent(this);this._mappedElements.push(A);var r=(function(B){var G=g(B.target);var F=G._jgDataRowContent();var D=F.datasetUI().dataset();var E=G.attr(_JGKeyword.ui.attrColumn);var C=F.rowIndex();D.setColumnValue(E,C,G.val(),true);});if(q==="input"){var j=NVL(A.attr("type"),"text");if(j==="checkbox"){A.on("click change",function(B){var G=g(B.target);var F=G._jgDataRowContent();var D=F.datasetUI().dataset();var E=G.attr(_JGKeyword.ui.attrColumn);var C=F.rowIndex();D.setColumnValue(E,C,G.prop("checked"),true);});}else{A.on("keyup change",r);}}else{if(q==="textarea"){A.on("change",function(B){var G=g(B.target);var F=G._jgDataRowContent();var D=F.datasetUI().dataset();var E=G.attr(_JGKeyword.ui.attrColumn);var C=F.rowIndex();D.setColumnValue(E,C,G.val(),true);});A.on("keyup",function(B){var C=g(B.target);C.trigger("change");});}else{if(q==="div"&&A.prop("contenteditable")){A.on("change",function(B){var G=g(B.target);var F=G._jgDataRowContent();var D=F.datasetUI().dataset();var E=G.attr(_JGKeyword.ui.attrColumn);var C=F.rowIndex();D.setColumnValue(E,C,G.html(),true);});A.on("keyup",function(B){var C=g(B.target);C.trigger("change");});}else{if(q==="select"){if(!isNull(A.attr(_JGKeyword.ui.attrBindDataset))){A.JGSelect();}A.on("change",function(B){var G=g(B.target);var F=G._jgDataRowContent();var D=F.datasetUI().dataset();var E=G.attr(_JGKeyword.ui.attrColumn);var C=F.rowIndex();D.setColumnValue(E,C,G.selectValue(),true);});g(A).on(_JGKeyword.select.trigger.selectReloaded,function(B){var G=g(B.target);var F=G._jgDataRowContent();var D=F.datasetUI().dataset();var E=G.attr(_JGKeyword.ui.attrColumn);var C=F.rowIndex();G.val(D.getColumnValue(E,C));});}else{}}}}}var t=this._rowContent.find("*");t.push(this._rowContent);var w=t.length;for(var p=0;p<w;++p){var o=g(t[p]);var x=o[0].attributes;var l=x.length;for(var m=0;m<l;++m){var i=x[m];var v=i.name.toLowerCase();if(i.name.toLowerCase()!=="jg-column"&&BLK(i.value).indexOf(_JGKeyword.ui.keyFXPrefix)===0){this._FXElements.push(new b(this,o,v,0));}}var y=o.html();if(BLK(y).indexOf(_JGKeyword.ui.keyFXPrefix)===0){this._FXElements.push(new b(this,o,null,1));}}});e.prototype.datasetUI=(function(){return this._datasetUI;});e.prototype.rowIndex=(function(){return this.datasetUI().indexOf(this);});e.prototype.rowContent=(function(){return this._rowContent;});e.prototype.mappedElements=(function(){return this._mappedElements;});e.prototype.FXElements=(function(){return this._FXElements;});e.prototype._refreshFX=(function(){var i=this.FXElements();var j=i.length;for(var k=0;k<j;++k){i[k].update();}});e.prototype._refreshColumn=(function(m,j){m=m.toUpperCase();j=NVL(j,true);var l=this.datasetUI().dataset().getColumnValue(m,this.rowIndex());var i=this.mappedElements();var o=i.length;for(eIndex_=0;eIndex_<o;++eIndex_){var k=g(i[eIndex_]);if(k.attr("jg-column").toUpperCase()===m){var n=k.prop("tagName").toLowerCase();if(n==="input"&&k.attr("type")==="checkbox"){l=(l===true||l==="true");if(k.prop("checked")!==l){k.prop("checked",l);}}else{if(n==="input"){if(k.val()!==l){k.val(l);}}else{if(n==="textarea"){if(k.val()!==l){k.val(l);}}else{if(n==="select"){if(k.val()!==l){k.val(l);}}else{l=BLK(l);if(k.html()!==l){k.html(l);}}}}}}}if(j){this._refreshFX();}});e.prototype._refresh=(function(){var i=this.datasetUI().dataset();var k=i.getColumnCount();for(var j=0;j<k;++j){this._refreshColumn(i.getColumn(j).getName(),false);}this._refreshFX();});var b=(function(l,j,k,i){this._rowContent=l;this._element=j;this._attrName=k;this._type=i;switch(i){case 0:this._fx=j.attr(k).substr(_JGKeyword.ui.keyFXPrefix.length);break;case 1:this._fx=j.html().substr(_JGKeyword.ui.keyFXPrefix.length);break;default:console.error("invaild FX Element Type");break;}});b.prototype.rowContent=(function(){return this._rowContent;});b.prototype.element=(function(){return this._element;});b.prototype.attrName=(function(){return this._attrName;});b.prototype.type=(function(){return this._type;});b.prototype.update=(function(){var m=this.rowContent();var k=m.datasetUI().dataset();var j=m.rowIndex();var i=null;try{i=BLK(new Function("return "+this._fx._jgFuncReplaceRegexpByDataset(k,j)+";").apply(k));}catch(l){i="##fx Exception: "+l.toString()+", statement: "+this._fx+"##";}switch(this.type()){case 0:this.element().attr(this.attrName(),i);break;case 1:this.element().html(i);break;default:console.error("invaild FX Element Type");break;}});var d=(function(k,l){var i=this;l=g.extend({datasetName:k.attr(_JGKeyword.ui.attrBindDataset),displayColumn:k.attr(_JGKeyword.ui.attrDisplayColumn),valueColumn:k.attr(_JGKeyword.ui.attrValueColumn)},l);this._element=k;this._datasetName=l.datasetName;this._displayColumn=l.displayColumn;this._valueColumn=l.valueColumn;var j=this.dataset();g(j).on(_JGKeyword.trigger._rowInserted+" "+_JGKeyword.trigger._rowRemoved+" "+_JGKeyword.trigger._rowMoved+" "+_JGKeyword.trigger._columnAdded+" "+_JGKeyword.trigger._columnRemoved+" "+_JGKeyword.trigger._columnValueChanged+" "+_JGKeyword.trigger._datasetClear+" "+_JGKeyword.trigger._datasetReset+" "+_JGKeyword.trigger._datasetChanged+" "+_JGKeyword.trigger._datasetSorted,function(m,n){i.reload();});this.reload();});d.prototype.element=(function(){return this._element;});d.prototype.dataset=(function(){return h("dataset",this._datasetName);});d.prototype.displayColumn=(function(){return this._displayColumn;});d.prototype.valueColumn=(function(){return this._valueColumn;});d.prototype.reload=(function(){var l=this.element();l.empty();function i(o,n){return g("<option value='"+n+"'>"+o+"</option>");}var k=this.dataset();var m=k.getRowCount();for(var j=0;j<m;++j){l.append(i(k.getColumnValue(this.displayColumn(),j),k.getColumnValue(this.valueColumn(),j)));}l.trigger(_JGKeyword.select.trigger.selectReloaded);});g.fn._jgSelect=(function(i){if(i!==undefined){this.data("jgdatasetJGSelect",i);}return this.data("jgdatasetJGSelect");});g.fn._jgSelectInitialized=(function(i){if(i!==undefined){this.data("jgdatasetJGSelectInitialized",i);}return NVL(this.data("jgdatasetJGSelectInitialized"),false);});g.fn.JGSelect=(function(){if(!this._jgSelectInitialized()){this._jgSelect(new d(this,arguments[0]));this._jgSelectInitialized(true);}return JGSelector(this._jgSelect(),arguments);});})(window,jQuery,JGDS);