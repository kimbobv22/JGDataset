(function(window,$){if(JGDS===undefined){console.error("can't not initialize JGDatasetUI, JGDataset not found");return}_JGKeyword=$.extend(true,window._JGKeyword,{ui:{attrDataset:"jg-dataset",attrColumn:"jg-column",attrBindDataset:"jg-bind-dataset",attrDisplayColumn:"jg-display-column",attrValueColumn:"jg-value-column",keyFXPrefix:"##fx:",trigger:{rowMapped:"datasetuirowmapped",refreshed:"datasetuirefreshed",FXRefreshed:"datasetuifxrefreshed",columnRefreshed:"datasetuicolumnrefreshed",mappingReloaded:"datasetuimappingreloaded"}},select:{trigger:{selectReloaded:"selectreloaded"}}});String.prototype._jgFuncConvertToColumnRegexp=(function(){return new RegExp("\\#\\#"+this+"\\#\\#","gi")});String.prototype._jgFuncReplaceRegexpByDataset=(function(dataset_,rowIndex_){var targetStr_=this;targetStr_=targetStr_.replace("dataset\\.rowCount"._jgFuncConvertToColumnRegexp(),dataset_.getRowCount());targetStr_=targetStr_.replace("dataset\\.columnCount"._jgFuncConvertToColumnRegexp(),dataset_.getColumnCount());targetStr_=targetStr_.replace("dataset\\.columnName"._jgFuncConvertToColumnRegexp(),dataset_.getColumnCount());var columnNameRegexp_=("dataset\\.columnName\\([0-9]+\\)")._jgFuncConvertToColumnRegexp();while(found_=columnNameRegexp_.exec(targetStr_)){var replaceTarget_=found_[0];var columnIndex_=replaceTarget_.substr(replaceTarget_.indexOf("(")+1);columnIndex_=columnIndex_.substr(0,columnIndex_.indexOf(")##"));targetStr_=targetStr_.replace(replaceTarget_,"this.getColumn("+columnIndex_+").getName()")}var staticticsRegexp_="[\\s\\w\\#\\@\\-\\+\\*\\/\\%]*";var sumRegexp_=("dataset\\.sum\\("+staticticsRegexp_+"\\)")._jgFuncConvertToColumnRegexp();while(found_=sumRegexp_.exec(targetStr_)){var replaceTarget_=found_[0];var columnName_=replaceTarget_.substr(replaceTarget_.indexOf("(")+1);columnName_=columnName_.substr(0,columnName_.indexOf(")##"));targetStr_=targetStr_.replace(replaceTarget_,"this.sumOfColumnValues('"+columnName_+"')")}sumRegexp_=("dataset\\.avg\\("+staticticsRegexp_+"\\)")._jgFuncConvertToColumnRegexp();while(found_=sumRegexp_.exec(targetStr_)){var replaceTarget_=found_[0];var columnName_=replaceTarget_.substr(replaceTarget_.indexOf("(")+1);columnName_=columnName_.substr(0,columnName_.indexOf(")##"));targetStr_=targetStr_.replace(replaceTarget_,"this.avgOfColumnValues('"+columnName_+"')")}sumRegexp_=("dataset\\.min\\("+staticticsRegexp_+"\\)")._jgFuncConvertToColumnRegexp();while(found_=sumRegexp_.exec(targetStr_)){var replaceTarget_=found_[0];var columnName_=replaceTarget_.substr(replaceTarget_.indexOf("(")+1);columnName_=columnName_.substr(0,columnName_.indexOf(")##"));targetStr_=targetStr_.replace(replaceTarget_,"this.minOfColumnValues('"+columnName_+"')")}sumRegexp_=("dataset\\.max\\("+staticticsRegexp_+"\\)")._jgFuncConvertToColumnRegexp();while(found_=sumRegexp_.exec(targetStr_)){var replaceTarget_=found_[0];var columnName_=replaceTarget_.substr(replaceTarget_.indexOf("(")+1);columnName_=columnName_.substr(0,columnName_.indexOf(")##"));targetStr_=targetStr_.replace(replaceTarget_,"this.maxOfColumnValues('"+columnName_+"')")}if(rowIndex_!==undefined){sumRegexp_=("dataset\\.plus\\("+staticticsRegexp_+"\\)")._jgFuncConvertToColumnRegexp();while(found_=sumRegexp_.exec(targetStr_)){var replaceTarget_=found_[0];var columnName_=replaceTarget_.substr(replaceTarget_.indexOf("(")+1);columnName_=columnName_.substr(0,columnName_.indexOf(")##"));var columnValueSum_=0;for(var tRowIndex_=0;tRowIndex_<=rowIndex_;++tRowIndex_){var columnValue_=parseInt(dataset_.getColumnValue(columnName_,tRowIndex_));columnValueSum_+=columnValue_}targetStr_=targetStr_.replace(replaceTarget_,columnValueSum_)}sumRegexp_=("dataset\\.minus\\("+staticticsRegexp_+"\\)")._jgFuncConvertToColumnRegexp();while(found_=sumRegexp_.exec(targetStr_)){var replaceTarget_=found_[0];var columnName_=replaceTarget_.substr(replaceTarget_.indexOf("(")+1);columnName_=columnName_.substr(0,columnName_.indexOf(")##"));var columnValueSum_=parseInt(dataset_.getColumnValue(columnName_,0));for(var tRowIndex_=1;tRowIndex_<=rowIndex_;++tRowIndex_){var columnValue_=parseInt(dataset_.getColumnValue(columnName_,tRowIndex_));columnValueSum_-=columnValue_}targetStr_=targetStr_.replace(replaceTarget_,columnValueSum_)}targetStr_=targetStr_.replace("dataset\\.rowIndex"._jgFuncConvertToColumnRegexp(),rowIndex_);targetStr_=targetStr_.replace("dataset\\.rowStatus"._jgFuncConvertToColumnRegexp(),dataset_.getRowStatus(rowIndex_));var columnCount_=dataset_.getColumnCount();for(var columnIndex_=0;columnIndex_<columnCount_;++columnIndex_){var columnItem_=dataset_.getColumn(columnIndex_);var columnName_=columnItem_.getName();var columnValue_=dataset_.getColumnValue(columnName_,rowIndex_);targetStr_=targetStr_.replace(columnName_._jgFuncConvertToColumnRegexp(),"this.getColumnValue('"+columnName_+"',"+rowIndex_+")")}}return targetStr_});String.prototype.replaceBlank=(function(res_){return this.replace(/^[\n\t]*/g,res_)});$.fn.insertAtIndex=(function(element_,index_){var lastIndex_=this.children().size();if(index_<0){index_=Math.max(0,lastIndex_+1+index_)}this.append(element_);if(index_<lastIndex_){this.children().eq(index_).before(this.children().last())}return this});$.fn.selectValue=(function(){if(this.prop("tagName").toLowerCase()!=="select"){return undefined}return this.children("option:selected").first().attr("value")});$.fn._jexecute=(function(executeFunc_,arguments_){var result_=new Array();$.each(this,function(){result_.push(executeFunc_.call($(this),arguments_))});return result_.length>1?result_:result_[0]});JGDataset.prototype.datasetUIView=(function(){return $(document).find("["+_JGKeyword.ui.attrDataset+"='"+this.getName()+"']").filter(function(){return $(this)._jgDatasetUIInitialized()})});var JGDatasetUI=window.JGDatasetUI=(function(element_,datasetName_,options_){var that_=this;this.options=$.extend(true,JGDatasetUI.prototype.options,options_);this._element=element_;this._datasetName=NVL(datasetName_,element_.attr(_JGKeyword.ui.attrDataset));if(isNull(this.dataset())){console.error("can't find JGDataset");return}this._originalRowContent=this._element.children().first().clone(true);this._element.empty();this._rowContents=new Array();var dataset_=this.dataset();$(dataset_).on(_JGKeyword.trigger._rowInserted,function(event_,rowIndex_){that_._insertRowContent(rowIndex_);that_._randerNoRow()});$(dataset_).on(_JGKeyword.trigger._rowRemoved,function(event_,rowIndex_){that_._removeRowContent(rowIndex_);that_._randerNoRow()});$(dataset_).on(_JGKeyword.trigger._rowMoved,function(event_,fromRowIndex_,toRowIndex_){if(fromRowIndex_>toRowIndex_){that_._refresh(toRowIndex_,fromRowIndex_)}else{that_._refresh(fromRowIndex_,toRowIndex_)}});$(dataset_).on(_JGKeyword.trigger._columnAdded+" "+_JGKeyword.trigger._columnRemoved,function(event_,columnName_){that_._refreshColumn(columnName_,undefined,undefined,false);that_._refreshFX()});$(dataset_).on(_JGKeyword.trigger._columnValueChanged,function(event_,columnName_,rowIndex_){that_._refreshColumn(columnName_,rowIndex_,undefined,false);that_._refreshFX()});$(dataset_).on(_JGKeyword.trigger._datasetClear+" "+_JGKeyword.trigger._datasetReset+" "+_JGKeyword.trigger._datasetChanged+" "+_JGKeyword.trigger._datasetSorted,function(event_,rowIndex_,oldRowIndex_){that_.reload();that_._randerNoRow()});$(dataset_).on(_JGKeyword.trigger._datasetApply,function(event_){that_._refreshFX()});this.reload()});JGDatasetUI.prototype.options={blankToNull:false,noRowContent:null};JGDatasetUI.prototype.element=(function(){return this._element});JGDatasetUI.prototype.dataset=(function(){return JGDS("dataset",this._datasetName)});JGDatasetUI.prototype.rowContent=(function(rowIndex_){return this._rowContents[rowIndex_]});JGDatasetUI.prototype._insertRowContent=(function(rowIndex_){var rowContent_=new JGRowContent(this,this._originalRowContent);this._rowContents.insert(rowContent_,rowIndex_);this.element().insertAtIndex(rowContent_.rowContent(),rowIndex_);this._refresh(rowIndex_,undefined,false);this.element().trigger(_JGKeyword.ui.trigger.rowMapped,[rowIndex_]);return rowContent_});JGDatasetUI.prototype._removeRowContent=(function(rowIndex_){var rowContent_=this.rowContent(rowIndex_);rowContent_.rowContent().remove();this._rowContents.remove(rowIndex_);this._refreshFX(0)});JGDatasetUI.prototype.indexOf=(function(rowContent_){return this._rowContents.indexOf(rowContent_)});JGDatasetUI.prototype._refreshFX=(function(fromRowIndex_,toRowIndex_,fireEvent_){var that_=this;this.dataset().each(fromRowIndex_,toRowIndex_,function(rowIndex_){that_.rowContent(rowIndex_)._refreshFX();if(NVL(fireEvent_,true)){$(that_.element()).trigger(_JGKeyword.ui.trigger.FXRefreshed,[rowIndex_])}})});JGDatasetUI.prototype._refreshColumn=(function(columnName_,fromRowIndex_,toRowIndex_,refreshFx_,fireEvent_){refreshFx_=NVL(refreshFx_,true);var that_=this;this.dataset().each(fromRowIndex_,toRowIndex_,function(rowIndex_){that_.rowContent(rowIndex_)._refreshColumn(columnName_,refreshFx_);if(NVL(fireEvent_,true)){$(that_.element()).trigger(_JGKeyword.ui.trigger.columnRefreshed,[columnName_,rowIndex_])}})});JGDatasetUI.prototype._refresh=(function(fromRowIndex_,toRowIndex_,fireEvent_){var that_=this;this.dataset().each(fromRowIndex_,toRowIndex_,function(rowIndex_){that_.rowContent(rowIndex_)._refresh();if(NVL(fireEvent_,true)){$(that_.element()).trigger(_JGKeyword.ui.trigger.refreshed,[rowIndex_])}})});JGDatasetUI.prototype._randerNoRow=(function(){if(this._noRowElement!==undefined&&this._noRowElement!==null){this._noRowElement.remove();this._noRowElement=null}var rowCount_=this.dataset().getRowCount();if(rowCount_<=0){var noRowContent_=NVL(this.options.noRowContent,"");if(noRowContent_!==""){this._noRowElement=$(noRowContent_);this.element().append(this._noRowElement)}}});JGDatasetUI.prototype.reload=(function(){this.element().empty();this._rowContents=new Array();var dataset_=this.dataset();var rowCount_=dataset_.getRowCount();var tempIndex_=0;while(tempIndex_<rowCount_){this._insertRowContent(this._rowContents.length);++tempIndex_}$(this.element()).trigger(_JGKeyword.ui.trigger.mappingReloaded)});$.fn._jgDatasetUI=(function(ui_){if(ui_!==undefined){this.data("jgdatasetJGDatasetUI",ui_)}return this.data("jgdatasetJGDatasetUI")});$.fn._jgDatasetUIInitialized=(function(bool_){if(bool_!==undefined){this.data("jgdatasetJGDatasetUIInitialized",bool_)}return NVL(this.data("jgdatasetJGDatasetUIInitialized"),false)});$.fn.JGDatasetUI=(function(){return this._jexecute(function(arguments_){if(!this._jgDatasetUIInitialized()){var datasetName_,options_;if($.type(arguments_[0])==="object"){options_=arguments_[0]}else{datasetName_=arguments_[0];options_=arguments_[1]}this._jgDatasetUI(new JGDatasetUI(this,datasetName_,options_));this._jgDatasetUIInitialized(true);return this}else{return JGSelector(this._jgDatasetUI(),arguments_)}},arguments)});$.fn._jgDataRowContent=(function(rowContent_){if(rowContent_===undefined){return this.data("jgdataset_rowContent")}this.data("jgdataset_rowContent",rowContent_);return this.data("jgdataset_rowContent")});$.fn._jgDataJGDataset=(function(){return this._jgDataRowContent().datasetUI().dataset()});var JGRowContent=(function(datasetUI_,rowContent_){this._datasetUI=datasetUI_;this._rowContent=rowContent_.clone(true,true);this._mappedElements=new Array();this._FXElements=new Array();var mappedElements_=this._rowContent.find("*["+_JGKeyword.ui.attrColumn+"]");var mappedElementsLength_=mappedElements_.length;for(var mapIndex_=0;mapIndex_<mappedElementsLength_;++mapIndex_){var mappedElement_=$(mappedElements_[mapIndex_]);var tagName_=mappedElement_.prop("tagName").toLowerCase();mappedElement_._jgDataRowContent(this);this._mappedElements.push(mappedElement_);var commonEventOnChange_=(function(event_){var target_=$(event_.target);var rowContent_=target_._jgDataRowContent();var datasetUI_=rowContent_.datasetUI();var dataset_=datasetUI_.dataset();var columnName_=target_.attr(_JGKeyword.ui.attrColumn);var rowIndex_=rowContent_.rowIndex();var columnValue_=target_.val();if(datasetUI_.options.blankToNull){columnValue_=BLK(columnValue_,null)}dataset_.setColumnValue(columnName_,rowIndex_,columnValue_,true)});if(tagName_==="input"){var inputType_=NVL(mappedElement_.attr("type"),"text");if(inputType_==="checkbox"){mappedElement_.on("click change",function(event_){var target_=$(event_.target);var rowContent_=target_._jgDataRowContent();var datasetUI_=rowContent_.datasetUI();var dataset_=datasetUI_.dataset();var columnName_=target_.attr(_JGKeyword.ui.attrColumn);var rowIndex_=rowContent_.rowIndex();dataset_.setColumnValue(columnName_,rowIndex_,target_.prop("checked"),true)})}else{mappedElement_.on("keyup change",commonEventOnChange_)}}else{if(tagName_==="textarea"){mappedElement_.on("change",function(event_){var target_=$(event_.target);var rowContent_=target_._jgDataRowContent();var datasetUI_=rowContent_.datasetUI();var dataset_=datasetUI_.dataset();var columnName_=target_.attr(_JGKeyword.ui.attrColumn);var rowIndex_=rowContent_.rowIndex();var columnValue_=target_.val();if(datasetUI_.options.blankToNull){columnValue_=BLK(columnValue_,null)}dataset_.setColumnValue(columnName_,rowIndex_,columnValue_,true)});mappedElement_.on("keyup",function(event_){var target_=$(event_.target);target_.trigger("change")})}else{if(tagName_==="div"&&mappedElement_.prop("contenteditable")){mappedElement_.on("change",function(event_){var target_=$(event_.target);var rowContent_=target_._jgDataRowContent();var datasetUI_=rowContent_.datasetUI();var dataset_=datasetUI_.dataset();var columnName_=target_.attr(_JGKeyword.ui.attrColumn);var rowIndex_=rowContent_.rowIndex();var columnValue_=target_.html();if(datasetUI_.options.blankToNull){columnValue_=BLK(columnValue_,null)}dataset_.setColumnValue(columnName_,rowIndex_,columnValue_,true)});mappedElement_.on("keyup",function(event_){var target_=$(event_.target);target_.trigger("change")})}else{if(tagName_==="select"){if(!isNull(mappedElement_.attr(_JGKeyword.ui.attrBindDataset))){mappedElement_.JGSelect()}mappedElement_.on("change",function(event_){var target_=$(event_.target);var rowContent_=target_._jgDataRowContent();var dataset_=rowContent_.datasetUI().dataset();var columnName_=target_.attr(_JGKeyword.ui.attrColumn);var rowIndex_=rowContent_.rowIndex();dataset_.setColumnValue(columnName_,rowIndex_,target_.selectValue(),true)});$(mappedElement_).on(_JGKeyword.select.trigger.selectReloaded,function(event_){var target_=$(event_.target);var rowContent_=target_._jgDataRowContent();var dataset_=rowContent_.datasetUI().dataset();var columnName_=target_.attr(_JGKeyword.ui.attrColumn);var rowIndex_=rowContent_.rowIndex();target_.val(dataset_.getColumnValue(columnName_,rowIndex_))})}else{}}}}}var fxElements_=this._rowContent.find("*");fxElements_.push(this._rowContent);var fxElementsLength_=fxElements_.length;for(var fxIndex_=0;fxIndex_<fxElementsLength_;++fxIndex_){var fxElement_=$(fxElements_[fxIndex_]);var attrs_=fxElement_[0].attributes;var attrCount_=attrs_.length;for(var attrIndex_=0;attrIndex_<attrCount_;++attrIndex_){var attr_=attrs_[attrIndex_];var attrName_=attr_.name.toLowerCase();if(attr_.name.toLowerCase()!==_JGKeyword.ui.attrColumn&&BLK(attr_.value).replaceBlank("").indexOf(_JGKeyword.ui.keyFXPrefix)===0){this._FXElements.push(new JGFXElement(fxElement_,attrName_,0))}}var textValue_=fxElement_.html();if(BLK(textValue_).replaceBlank("").indexOf(_JGKeyword.ui.keyFXPrefix)===0){this._FXElements.push(new JGFXElement(fxElement_,null,1))}}});JGRowContent.prototype.datasetUI=(function(){return this._datasetUI});JGRowContent.prototype.rowIndex=(function(){return this.datasetUI().indexOf(this)});JGRowContent.prototype.rowContent=(function(){return this._rowContent});JGRowContent.prototype.mappedElements=(function(){return this._mappedElements});JGRowContent.prototype.FXElements=(function(){return this._FXElements});JGRowContent.prototype._refreshFX=(function(){var fxElements_=this.FXElements();var dataset_=this.datasetUI().dataset();var rowIndex_=this.rowIndex();var fxElementsLength_=fxElements_.length;for(var fxIndex_=0;fxIndex_<fxElementsLength_;++fxIndex_){fxElements_[fxIndex_].update(dataset_,rowIndex_)}});JGRowContent.prototype._refreshColumn=(function(columnName_,refreshFX_){columnName_=columnName_.toUpperCase();refreshFX_=NVL(refreshFX_,true);var columnValue_=this.datasetUI().dataset().getColumnValue(columnName_,this.rowIndex());var mappedElements_=this.mappedElements();var eCount_=mappedElements_.length;for(eIndex_=0;eIndex_<eCount_;++eIndex_){var mappedElement_=$(mappedElements_[eIndex_]);if(mappedElement_.attr(_JGKeyword.ui.attrColumn).toUpperCase()===columnName_){var tagName_=mappedElement_.prop("tagName").toLowerCase();if(tagName_==="input"&&mappedElement_.attr("type")==="checkbox"){columnValue_=(columnValue_===true||columnValue_==="true");if(mappedElement_.prop("checked")!==columnValue_){mappedElement_.prop("checked",columnValue_)}}else{if(tagName_==="input"){if(mappedElement_.val()!==columnValue_){mappedElement_.val(columnValue_)}}else{if(tagName_==="textarea"){if(mappedElement_.val()!==columnValue_){mappedElement_.val(columnValue_)}}else{if(tagName_==="select"){if(mappedElement_.val()!==columnValue_){mappedElement_.val(columnValue_)}}else{columnValue_=BLK(columnValue_);if(mappedElement_.html()!==columnValue_){mappedElement_.html(columnValue_)}}}}}}}if(refreshFX_){this._refreshFX()}});JGRowContent.prototype._refresh=(function(){var dataset_=this.datasetUI().dataset();var colCount_=dataset_.getColumnCount();for(var colIndex_=0;colIndex_<colCount_;++colIndex_){this._refreshColumn(dataset_.getColumn(colIndex_).getName(),false)}this._refreshFX()});var JGFXElement=window.JGFXElement=(function(element_,attrName_,type_){this._element=element_;this._attrName=attrName_;this._type=type_;switch(type_){case 0:this._fx=element_.attr(attrName_).replaceBlank("").substr(_JGKeyword.ui.keyFXPrefix.length);break;case 1:this._fx=element_.html().replaceBlank("").substr(_JGKeyword.ui.keyFXPrefix.length);break;default:console.error("invaild FX Element Type");break}});JGFXElement.prototype.element=(function(){return this._element});JGFXElement.prototype.attrName=(function(){return this._attrName});JGFXElement.prototype.type=(function(){return this._type});JGFXElement.prototype.update=(function(dataset_,rowIndex_){var resultStr_=null;try{resultStr_=BLK(new Function("return "+this._fx._jgFuncReplaceRegexpByDataset(dataset_,rowIndex_)+";").apply(dataset_))}catch(ex_){resultStr_="##fx Exception: "+ex_.toString()+", statement: "+this._fx+"##"}switch(this.type()){case 0:this.element().attr(this.attrName(),resultStr_);break;case 1:this.element().html(resultStr_);break;default:console.error("invaild FX Element Type");break}});var JGSelect=(function(element_,options_){var that_=this;options_=$.extend({datasetName:element_.attr(_JGKeyword.ui.attrBindDataset),displayColumn:element_.attr(_JGKeyword.ui.attrDisplayColumn),valueColumn:element_.attr(_JGKeyword.ui.attrValueColumn)},options_);this._element=element_;this._datasetName=options_.datasetName;this._displayColumn=options_.displayColumn;this._valueColumn=options_.valueColumn;var dataset_=this.dataset();$(dataset_).on(_JGKeyword.trigger._rowInserted+" "+_JGKeyword.trigger._rowRemoved+" "+_JGKeyword.trigger._rowMoved+" "+_JGKeyword.trigger._columnAdded+" "+_JGKeyword.trigger._columnRemoved+" "+_JGKeyword.trigger._columnValueChanged+" "+_JGKeyword.trigger._datasetClear+" "+_JGKeyword.trigger._datasetReset+" "+_JGKeyword.trigger._datasetChanged+" "+_JGKeyword.trigger._datasetSorted,function(event_,rowIndex_){that_.reload()});this.reload()});JGSelect.prototype.element=(function(){return this._element});JGSelect.prototype.dataset=(function(){return JGDS("dataset",this._datasetName)});JGSelect.prototype.displayColumn=(function(){return this._displayColumn});JGSelect.prototype.valueColumn=(function(){return this._valueColumn});JGSelect.prototype.reload=(function(){var element_=this.element();element_.empty();function createOptionElement_(display_,value_){return $("<option value='"+value_+"'>"+display_+"</option>")}var dataset_=this.dataset();var rowCount_=dataset_.getRowCount();for(var rowIndex_=0;rowIndex_<rowCount_;++rowIndex_){element_.append(createOptionElement_(dataset_.getColumnValue(this.displayColumn(),rowIndex_),dataset_.getColumnValue(this.valueColumn(),rowIndex_)))}element_.trigger(_JGKeyword.select.trigger.selectReloaded)});$.fn._jgSelect=(function(select_){if(select_!==undefined){this.data("jgdatasetJGSelect",select_)}return this.data("jgdatasetJGSelect")});$.fn._jgSelectInitialized=(function(bool_){if(bool_!==undefined){this.data("jgdatasetJGSelectInitialized",bool_)}return NVL(this.data("jgdatasetJGSelectInitialized"),false)});$.fn.JGSelect=(function(){return this._jexecute(function(arguments_){if(!this._jgSelectInitialized()){this._jgSelect(new JGSelect(this,arguments_[0]));this._jgSelectInitialized(true);return this}else{return JGSelector(this._jgSelect(),arguments_)}},arguments)})})(window,jQuery);