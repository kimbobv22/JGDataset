(function(a,e,f){if(f===undefined){console.error("can't not initialize JGDataset UI, JGDataset not found");return;}_JGKeyword=e.extend(true,a._JGKeyword,{ui:{attrDataset:"jg-dataset",attrColumn:"jg-column",attrBindDataset:"jg-bind-dataset",attrDisplayColumn:"jg-display-column",attrValueColumn:"jg-value-column",keyFXPrefix:"##fx:",trigger:{rowMapped:"datasetuirowmapped",refreshed:"datasetuirefreshed",FXRefreshed:"datasetuifxrefreshed",columnRefreshed:"datasetuicolumnrefreshed",mappingReloaded:"datasetuimappingreloaded"}},select:{trigger:{selectReloaded:"selectreloaded"}}});String.prototype._jgFuncConvertToColumnRegexp=(function(){return new RegExp("\\#\\#("+this+")\\#\\#","gi");});String.prototype._jgFuncReplaceRegexpByDataset=(function(h,s){var r=this;r=r.replace("dataset\\.rowIndex"._jgFuncConvertToColumnRegexp(),s);r=r.replace("dataset\\.rowStatus"._jgFuncConvertToColumnRegexp(),h.getRowStatus(s));r=r.replace("dataset\\.rowCount"._jgFuncConvertToColumnRegexp(),h.getRowCount());r=r.replace("dataset\\.columnCount"._jgFuncConvertToColumnRegexp(),h.getRowCount());var j="dataset\\.sum\\([\\s\\w\\#\\@\\-\\+\\*\\/\\%]*\\)"._jgFuncConvertToColumnRegexp();if(j.test(r)){var k=h.getColumnCount();for(var l=0;l<k;++l){var p=h.getColumn(l);var q=p.getName();var i=q._jgFuncConvertToColumnRegexp();if(i.test(r)){var o=0;for(var n=0;n<=s;++n){var m=parseInt(h.getColumnValue(q,n));o+=m;}r=r.replace(i,o);}}r=r.replace("dataset\\.sum"._jgFuncConvertToColumnRegexp(),h.getRowCount());r=r.substr(r.indexOf("(")+1);r=r.substr(0,r.indexOf(")##"));}var k=h.getColumnCount();for(var l=0;l<k;++l){var p=h.getColumn(l);var q=p.getName();var m=h.getColumnValue(q,s);r=r.replace(q._jgFuncConvertToColumnRegexp(),Object.NVL(m,"null"));}return r;});e.fn.insertAtIndex=(function(i,j){var h=this.children().size();if(j<0){j=Math.max(0,h+1+j);}this.append(i);if(j<h){this.children().eq(j).before(this.children().last());}return this;});e.fn.selectValue=(function(){if(this.prop("tagName").toLowerCase()!=="select"){return undefined;}return this.children("option:selected").first().attr("value");});JGDataset.prototype.datasetUIView=(function(){return e(document).find("["+_JGKeyword.ui.attrDataset+"='"+this.getName()+"']").filter(function(){return e(this)._jgDatasetUIInitialized();});});var d=a.JGDatasetUI=(function(j){var h=this;this._element=j;this._datasetName=j.attr(_JGKeyword.ui.attrDataset);if(Object.isNull(this.dataset())){console.error("can't find JGDataset");return;}this._originalRowContent=this._element.children().first().clone(true);this._element.empty();this._rowContents=new Array();var i=this.dataset();e(i).on(_JGKeyword.trigger._rowInserted,function(k,l){h._insertRowContent(l);});e(i).on(_JGKeyword.trigger._rowRemoved,function(k,l){h._removeRowContent(l);});e(i).on(_JGKeyword.trigger._rowMoved,function(k,l,m){if(m>l){h._refresh(l,m);}else{h._refresh(m,l);}});e(i).on(_JGKeyword.trigger._columnAdded+" "+_JGKeyword.trigger._columnRemoved,function(k,l){h._refreshColumn(l,undefined,undefined,false);h._refreshFX();});e(i).on(_JGKeyword.trigger._columnValueChanged,function(k,m,l){h._refreshColumn(m,l,undefined,false);h._refreshFX();});e(i).on(_JGKeyword.trigger._datasetClear+" "+_JGKeyword.trigger._datasetReset+" "+_JGKeyword.trigger._datasetChanged+" "+_JGKeyword.trigger._datasetSorted,function(k,l,m){h.reload();});e(i).on(_JGKeyword.trigger._datasetApply,function(k){h._refreshFX();});this.reload();});d.prototype.element=(function(){return this._element;});d.prototype.dataset=(function(){return f("dataset",this._datasetName);});d.prototype.rowContent=(function(h){return this._rowContents[h];});d.prototype._insertRowContent=(function(h){var i=new JGRowContent(this,this._originalRowContent);this._rowContents.insert(i,h);this.element().insertAtIndex(i.rowContent(),h);this._refresh(h,undefined,false);this.element().trigger(_JGKeyword.ui.trigger.rowMapped,[h]);return i;});d.prototype._removeRowContent=(function(h){var i=this.rowContent(h);i.rowContent().remove();this._rowContents.remove(h);this._refreshFX(h);});d.prototype.indexOf=(function(h){return this._rowContents.indexOf(h);});d.prototype.__rowRangeRefresh=(function(i,k,h){var l=this.dataset().getRowCount();if(Object.isNull(i)){i=Object.NVL(i,0);k=Object.NVL(k,l-1);}else{k=Object.NVL(k,i);}for(var j=i;j<=k;++j){h(this,j);}});d.prototype._refreshFX=(function(h,j,i){this.__rowRangeRefresh(h,j,function(k,l){k.rowContent(l)._refreshFX();if(Object.NVL(i,true)){e(k.element()).trigger(_JGKeyword.ui.trigger.FXRefreshed,[l]);}});});d.prototype._refreshColumn=(function(k,h,j,l,i){l=Object.NVL(l,true);this.__rowRangeRefresh(h,j,function(m,n){m.rowContent(n)._refreshColumn(k,l);if(Object.NVL(i,true)){e(m.element()).trigger(_JGKeyword.ui.trigger.columnRefreshed,[k,n]);}});});d.prototype._refresh=(function(h,j,i){this.__rowRangeRefresh(h,j,function(k,l){k.rowContent(l)._refresh();if(Object.NVL(i,true)){e(k.element()).trigger(_JGKeyword.ui.trigger.refreshed,[l]);}});});d.prototype.reload=(function(){this.element().empty();this._rowContents=new Array();var i=this.dataset();var j=i.getRowCount();var h=0;while(h<j){this._insertRowContent(this._rowContents.length);++h;}e(this.element()).trigger(_JGKeyword.ui.trigger.mappingReloaded);});e.fn._jgDatasetUI=(function(h){if(h!==undefined){this.data("jgdataset_jgDatasetUI",h);}return this.data("jgdataset_jgDatasetUI");});e.fn._jgDatasetUIInitialized=(function(h){if(h!==undefined){this.data("jgdataset_jgDatasetInitialized",h);}return Object.NVL(this.data("jgdataset_jgDatasetInitialized"),false);});e.fn.JGDatasetUI=(function(){if(!this._jgDatasetUIInitialized()){this._jgDatasetUI(new JGDatasetUI(this));this._jgDatasetUIInitialized(true);}return JGSelector(this._jgDatasetUI(),arguments);});e.fn._jgDataRowContent=(function(h){if(h===undefined){return this.data("jgdataset_rowContent");}this.data("jgdataset_rowContent",h);return this.data("jgdataset_rowContent");});e.fn._jgDataJGDataset=(function(){return this._jgDataRowContent().datasetUI().dataset();});var c=a.JGRowContent=(function(j,r){this._datasetUI=j;this._rowContent=r.clone(true,true);this._mappedElements=new Array();this._FXElements=new Array();var y=this._rowContent.find("*["+_JGKeyword.ui.attrColumn+"]");var t=y.length;for(var m=0;m<t;++m){var z=e(y[m]);var p=z.prop("tagName").toLowerCase();z._jgDataRowContent(this);this._mappedElements.push(z);var q=(function(A){var F=e(A.target);var E=F._jgDataRowContent();var C=E.datasetUI().dataset();var D=F.attr(_JGKeyword.ui.attrColumn);var B=E.rowIndex();C.setColumnValue(D,B,F.val(),true);});if(p==="input"){var i=Object.NVL(z.attr("type"),"text");if(i==="checkbox"){z.on("click change",function(A){var F=e(A.target);var E=F._jgDataRowContent();var C=E.datasetUI().dataset();var D=F.attr(_JGKeyword.ui.attrColumn);var B=E.rowIndex();C.setColumnValue(D,B,F.prop("checked"),true);});}else{z.on("keyup change",q);}}else{if(p==="div"&&z.prop("contenteditable")){z.on("change",function(A){var F=e(A.target);var E=F._jgDataRowContent();var C=E.datasetUI().dataset();var D=F.attr(_JGKeyword.ui.attrColumn);var B=E.rowIndex();C.setColumnValue(D,B,F.html(),true);});z.on("keyup",function(A){var B=e(A.target);B.trigger("change");});}else{if(p==="select"){if(!Object.isNull(z.attr(_JGKeyword.ui.attrBindDataset))){z.JGSelect();}z.on("change",function(A){var F=e(A.target);var E=F._jgDataRowContent();var C=E.datasetUI().dataset();var D=F.attr(_JGKeyword.ui.attrColumn);var B=E.rowIndex();C.setColumnValue(D,B,F.selectValue(),true);});e(z).on(_JGKeyword.select.trigger.selectReloaded,function(A){var F=e(A.target);var E=F._jgDataRowContent();var C=E.datasetUI().dataset();var D=F.attr(_JGKeyword.ui.attrColumn);var B=E.rowIndex();F.val(C.getColumnValue(D,B));});}else{}}}}var s=this._rowContent.find("*");s.push(this._rowContent);var v=s.length;for(var o=0;o<v;++o){var n=e(s[o]);var w=n[0].attributes;var k=w.length;for(var l=0;l<k;++l){var h=w[l];var u=h.name.toLowerCase();if(h.name.toLowerCase()!=="jg-column"&&Object.NVL(h.value,"").indexOf(_JGKeyword.ui.keyFXPrefix)===0){this._FXElements.push(new JGFXElement(this,n,u,0));}}var x=n.html();if(Object.NVL(x,"").indexOf(_JGKeyword.ui.keyFXPrefix)===0){this._FXElements.push(new JGFXElement(this,n,null,1));}}});c.prototype.datasetUI=(function(){return this._datasetUI;});c.prototype.rowIndex=(function(){return this.datasetUI().indexOf(this);});c.prototype.rowContent=(function(){return this._rowContent;});c.prototype.mappedElements=(function(){return this._mappedElements;});c.prototype.FXElements=(function(){return this._FXElements;});c.prototype._refreshFX=(function(){var h=this.FXElements();var i=h.length;for(var j=0;j<i;++j){h[j].update();}});c.prototype._refreshColumn=(function(l,i){l=l.toUpperCase();i=Object.NVL(i,true);var k=this.datasetUI().dataset().getColumnValue(l,this.rowIndex());var h=this.mappedElements();var n=h.length;for(eIndex_=0;eIndex_<n;++eIndex_){var j=e(h[eIndex_]);if(j.attr("jg-column").toUpperCase()===l){var m=j.prop("tagName").toLowerCase();if(m==="input"&&j.attr("type")==="checkbox"){k=(k===true||k==="true");if(j.prop("checked")!==k){j.prop("checked",k);}}else{if(m==="input"){if(j.val()!==k){j.val(k);}}else{if(m==="select"){if(j.val()!==k){j.val(k);}}else{k=Object.NVL(k,"");if(j.html()!==k){j.html(k);}}}}}}if(i){this._refreshFX();}});c.prototype._refresh=(function(){var h=this.datasetUI().dataset();var j=h.getColumnCount();for(var i=0;i<j;++i){this._refreshColumn(h.getColumn(i).getName(),false);}this._refreshFX();});var g=a.JGFXElement=(function(k,i,j,h){this._rowContent=k;this._element=i;this._attrName=j;this._type=h;switch(h){case 0:this._fx=i.attr(j).substr(_JGKeyword.ui.keyFXPrefix.length);break;case 1:this._fx=i.html().substr(_JGKeyword.ui.keyFXPrefix.length);break;default:console.error("invaild FX Element Type");break;}});g.prototype.rowContent=(function(){return this._rowContent;});g.prototype.element=(function(){return this._element;});g.prototype.attrName=(function(){return this._attrName;});g.prototype.type=(function(){return this._type;});g.prototype.update=(function(){var l=this.rowContent();var j=l.datasetUI().dataset();var i=l.rowIndex();var h=null;try{h=Object.NVL(new Function("return "+this._fx._jgFuncReplaceRegexpByDataset(j,i)+";").apply(j),"");}catch(k){h="##fx Exception: "+k.toString()+", statement: "+this._fx+"##";}switch(this.type()){case 0:this.element().attr(this.attrName(),h);break;case 1:this.element().html(h);break;default:console.error("invaild FX Element Type");break;}});var b=a.JGSelect=(function(j){var h=this;this._element=j;this._datasetName=j.attr(_JGKeyword.ui.attrBindDataset);this._displayColumn=j.attr(_JGKeyword.ui.attrDisplayColumn);this._valueColumn=j.attr(_JGKeyword.ui.attrValueColumn);var i=this.dataset();e(i).on(_JGKeyword.trigger._rowInserted+" "+_JGKeyword.trigger._rowRemoved+" "+_JGKeyword.trigger._rowMoved+" "+_JGKeyword.trigger._columnAdded+" "+_JGKeyword.trigger._columnRemoved+" "+_JGKeyword.trigger._columnValueChanged+" "+_JGKeyword.trigger._datasetClear+" "+_JGKeyword.trigger._datasetReset+" "+_JGKeyword.trigger._datasetChanged+" "+_JGKeyword.trigger._datasetSorted,function(k,l){h.reload();});this.reload();});b.prototype.element=(function(){return this._element;});b.prototype.dataset=(function(){return f("dataset",this._datasetName);});b.prototype.displayColumn=(function(){return this._displayColumn;});b.prototype.valueColumn=(function(){return this._valueColumn;});b.prototype.reload=(function(){var k=this.element();k.empty();function h(n,m){return e("<option value='"+m+"'>"+n+"</option>");}var j=this.dataset();var l=j.getRowCount();for(var i=0;i<l;++i){k.append(h(j.getColumnValue(this.displayColumn(),i),j.getColumnValue(this.valueColumn(),i)));}k.trigger(_JGKeyword.select.trigger.selectReloaded);});e.fn._jgSelect=(function(h){if(h!==undefined){this.data("jgdataset_jgSelect",h);}return this.data("jgdataset_jgSelect");});e.fn._jgSelectInitialized=(function(h){if(h!==undefined){this.data("jgdataset_jgSelectInitialized",h);}return Object.NVL(this.data("jgdataset_jgSelectInitialized"),false);});e.fn.JGSelect=(function(){if(!this._jgSelectInitialized()){this._jgSelect(new JGSelect(this));this._jgSelectInitialized(true);}return JGSelector(this._jgSelect(),arguments);});})(window,jQuery,JGDS);